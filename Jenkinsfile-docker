/* groovylint-disable NestedBlockDepth */
/* groovylint-disable-next-line CompileStatic */
pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
        timestamps() //Add timestamps to the Console Output
    }

    stages{
        stage('Docker Workflow') {
            stages{
              
                stage('Docker Build') {
                    steps {
                        echo 'Building'
                        bat "docker build github.com/ramyabala221190/jenkinsTest.git#${env.Branch} -t jenkins-test:${environment} --build-arg env=${environment}"
                    }
                }
                stage('Docker Run in Prod') {
                    when {
                        environment name: 'environment', value: 'prod'
                    }
                    steps {
                        echo 'Running Docker run in Prod'
                        script{                            
                            // def containerExists= bat 'docker ps --filter "name=jenkins-prod-container"'
                            // echo "${containerExists}"
                            // if(containerExists){
                            //     bat 'docker stop jenkins-prod-container'
                            //     bat 'docker remove jenkins-prod-container'
                            // }
                            bat "docker run --name jenkins-prod-container -dp 8083:80 -it jenkins-test:${environment}"
                        }
                    }
                }
                stage('Docker Run in Dev') {
                    when {
                        environment name: 'environment', value: 'dev'
                    }
                    steps {
                        echo 'Running Docker run in Dev'
                        script{
                            // def containerExists= bat 'docker ps --filter "name=jenkins-test-container"'
                            // echo "${containerExists}"
                            // if(containerExists){
                            //     bat 'docker stop jenkins-test-container'
                            //     bat 'docker remove jenkins-test-container'
                            // }
                            bat "docker run --name jenkins-test-container -dp 8082:80 -it jenkins-test:${environment}"
                        }
                    }
                }
            }
        }
    }
}